name: Build WPPConnect Mobile

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/21.0.8-9/x64
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2️⃣ Set up Java
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      # 3️⃣ Download your keystore artifact (if you uploaded it in another workflow)
      # Replace the URL with your actual artifact download URL if needed
      - name: Download Keystore
        run: |
          curl -L -o android/release-key.jks https://github.com/moshe-max/android-key-tool/actions/runs/18857060257/artifacts/4387371200

      # 4️⃣ Make Gradle Wrapper executable
      - name: Make Gradlew Executable
        run: chmod +x android/gradlew

      # 5️⃣ Build the release APK
      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$PWD/release-key.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.STORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}

      # 6️⃣ Upload the APK as artifact
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: wppconnect-release-apk
          path: android/app/build/outputs/apk/release/app-release.apk
